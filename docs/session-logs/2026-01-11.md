# Session Log: 2026-01-11 - Production Deployment & Performance-Optimierung

## üéØ Ziel der Session
Production Deployment abschlie√üen und Performance-Probleme beheben

## ‚úÖ Erreichte Meilensteine

### 1. Datenbank 1:1 Migration
**Problem:** Lokale Datenbank hatte 22 Tabellen, Production nur teilweise importiert
**L√∂sung:**
- Export-Script erstellt: `export-database-php.php` (da mysqldump nicht verf√ºgbar)
- Vollst√§ndiger Export: 22 Tabellen, 314 KB
- Datei: `database/production-full-dump.sql`
- Import auf Production erfolgreich

**Dateien:**
- `/export-database-php.php`
- `/database/production-full-dump.sql`

### 2. Apache .htaccess Konfiguration
**Problem:** CSS nicht geladen, Navigation funktionierte nicht
**L√∂sung:**
```apache
RewriteEngine On

# HTTPS Redirect
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Statische Assets ZUERST
RewriteRule ^assets/(.*)$ src/assets/$1 [L]
RewriteRule ^favicon\.(.*)$ src/favicon.$1 [L]

# Router NUR f√ºr nicht-existierende Dateien
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ src/router.php?route=$1 [L,QSA]

DirectoryIndex src/router.php
Options -Indexes
```

**Kritische Fixes:**
- `?route=$1` Parameter hinzugef√ºgt
- RewriteCond Zeilen vor Router-Regel
- Assets-Pfade VOR Router-Regel

### 3. Content Security Policy
**Problem:** CSS von www.pc-wittfoot.de blockiert, wenn Seite ohne www aufgerufen
**L√∂sung:** CSP erweitert in `src/core/Security.php`
```php
header("Content-Security-Policy: default-src 'self' http://pc-wittfoot.de https://pc-wittfoot.de http://www.pc-wittfoot.de https://www.pc-wittfoot.de; ...");
```

**BASE_URL ge√§ndert:**
- Von: `https://www.pc-wittfoot.de`
- Zu: `https://pc-wittfoot.de` (ohne www)

### 4. Performance-Optimierung: HelloCash Async
**Problem:** Buchungs-Best√§tigung dauerte 8-9 Sekunden (HelloCash API Call blocking)

**Versuchte L√∂sungen:**
1. ‚ùå `fastcgi_finish_request()` - nicht verf√ºgbar auf Server
2. ‚ùå `ob_end_flush() + flush()` - trotzdem 10 Sekunden

**Finale L√∂sung:** Asynchroner Cronjob
- HelloCash-Sync aus `src/api/booking.php` entfernt
- Buchung wird mit `hellocash_customer_id = NULL` gespeichert
- Cronjob synchronisiert nachtr√§glich

**Ergebnis:** Buchungs-Response < 1 Sekunde ‚úÖ

### 5. Button-Disable gegen Doppelbuchungen
**Problem:** W√§hrend 8-Sekunden-Wartezeit konnten User mehrfach klicken

**L√∂sung in `src/pages/termin.php` (Zeile 945+):**
```javascript
document.getElementById('booking-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Button deaktivieren
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Wird gebucht...';

    // ... Booking Logic ...

    // Bei Fehler wieder aktivieren
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
});
```

### 6. HelloCash Cronjob Implementation
**Datei:** `/cronjobs/sync-hellocash.php`

**Features:**
- Findet alle Buchungen ohne HelloCash-ID
- Limit 50 Buchungen pro Lauf
- Ruft `HelloCashClient::findOrCreateUser()` auf
- Speichert HelloCash-ID in Buchung
- Logging mit Timestamps
- Exit Code 0 bei Erfolg, 1 bei Fehlern
- 0.2s Pause zwischen API-Calls (API-Rate-Limit)

**Crontab-Eintrag:**
```cron
*/5 * * * * /usr/bin/php /home/www/doc/28552/dcp285520007/pc-wittfoot.de/www/cronjobs/sync-hellocash.php >> /home/www/doc/28552/dcp285520007/pc-wittfoot.de/www/logs/cronjob.log 2>&1
```

**Fixes:**
- Require-Pfad: `Database.php` ‚Üí `database.php` (lowercase)
- Kommentar-Block: Crontab-Syntax entfernt (wurde als PHP geparst)

### 7. Weitere Bug-Fixes
- ‚úÖ Email-Template Preview 404 ‚Üí `src/test-email-preview.php` auf Server kopiert
- ‚úÖ Admin-Login "Ung√ºltige Anmeldedaten" ‚Üí Password-Hash neu generiert
- ‚úÖ config.php mit Dev-Settings ‚Üí `config.production.php` kopiert
- ‚úÖ .htaccess deleted nach `git reset` ‚Üí manuell neu erstellt

## üìä Performance-Verbesserung

| Metrik | Vorher | Nachher |
|--------|--------|---------|
| Buchungs-Response | 8-9 Sekunden | < 1 Sekunde |
| HelloCash-Sync | Blocking | Async (Cronjob) |
| Doppelbuchungen | M√∂glich | Verhindert |

## üîß Git Workflow

```bash
# Lokale √Ñnderungen
git add .
git commit -m "Message"
git push origin master

# Production Branch
git checkout production
git merge master
git push origin production
git checkout master

# Production Server
ssh dcp285520007@www116.c.artfiles.de
cd /home/www/doc/28552/dcp285520007/pc-wittfoot.de/www
git pull origin production
```

## üöÄ Production Server Details

**Host:** www116.c.artfiles.de
**User:** dcp285520007
**Web Root:** `/home/www/doc/28552/dcp285520007/pc-wittfoot.de/www`
**Database:** sql116.c.artfiles.de / db285520001
**Live URL:** https://pc-wittfoot.de

## üìù Wichtige Erkenntnisse

1. **Heredoc via SSH funktioniert nicht zuverl√§ssig** ‚Üí Besser: `echo "line" >> file`
2. **Git-Workflow nutzen statt manuelles Kopieren** ‚Üí Schneller und sicherer
3. **Vollst√§ndige DB-Migration statt piecemeal** ‚Üí Verhindert Inkonsistenzen
4. **Performance √ºber Completeness** ‚Üí Fast response wichtiger als synchroner Sync
5. **BASE_URL ohne www** ‚Üí Einfacher f√ºr CSP und weniger Redirects

## üêõ Gel√∂ste Probleme

1. ‚úÖ Database Schema incomplete
2. ‚úÖ CSS MIME-Type errors
3. ‚úÖ Navigation links not working
4. ‚úÖ CSP blocking assets
5. ‚úÖ Booking performance (8-9s)
6. ‚úÖ Double-booking possible
7. ‚úÖ HelloCash sync blocking
8. ‚úÖ Email template preview 404
9. ‚úÖ Admin login broken
10. ‚úÖ Config overwritten by git

## üìã Offene Punkte

- [ ] Vollst√§ndiges Production-Testing (Buchung, Email, Mobile)
- [ ] Datenschutzerkl√§rung erstellen
- [ ] Blog-System √ºberarbeiten
- [ ] PayPal-Integration
- [ ] Shop f√ºr Production vorbereiten

## üéì Lessons Learned

### Was gut lief:
- Git-basierter Deployment-Workflow
- Schnelle Problemidentifikation
- Pragmatische L√∂sungen (async statt blocking)

### Was verbessert werden kann:
- Fr√ºher vollst√§ndige DB-Migration
- Bessere SSH-Tool-Kompatibilit√§t testen
- Production-Checklist vor Deployment

## üì¶ Ge√§nderte Dateien (Commits)

```
11dd86d - Fix: Cronjob require-Pfad database.php (lowercase)
9f88611 - Performance: HelloCash-Sync asynchron per Cronjob
6c3f6e2 - Fix: Button-Disable bei Buchung gegen Doppelbuchungen
... (siehe Git Log)
```

---

## Session 2 (Abend): HTML-Signatur mit Logo

### 8. HTML Email-Signatur Implementation

**Ziel:** Email-Signatur mit Logo-Support und Plaintext-Fallback

**Features:**
- ‚úÖ HTML-Signatur mit `{logo_url}` Platzhalter
- ‚úÖ Automatische Plaintext-Generierung aus HTML (wie Email-Templates)
- ‚úÖ Logo-Auswahl: `logo-square.svg` (Empfohlen)
- ‚úÖ Modal-Vorschau mit iframe (Dark-Mode kompatibel)
- ‚úÖ Nur ein Textarea-Feld (UX-Verbesserung)

**Datenbank-Migration:** `database/migrations/019_email_signature_html.sql`
```sql
ALTER TABLE email_signature
ADD COLUMN signature_html TEXT NULL,
ADD COLUMN signature_plaintext TEXT NULL,
ADD COLUMN logo_filename VARCHAR(255) NULL;
```

**Ge√§nderte Dateien:**
- `src/admin/email-templates.php` - UI und Auto-Plaintext-Generierung
- `src/assets/images/email/logo-square.svg` - Logo f√ºr Email-Signatur
- `docs/08-deployment-ops.md` - Deployment-Lessons dokumentiert

**Lokale Tests:**
- ‚úÖ Migration ausgef√ºhrt
- ‚úÖ Logo wird in Vorschau angezeigt
- ‚úÖ Plaintext wird automatisch generiert
- ‚úÖ Dark-Mode Vorschau funktioniert

### 9. Production Deployment Incident & Recovery

**Was passierte:**
- ‚ùå Erster Deployment-Versuch ging schief (git pull ohne Backup)
- ‚ùå config.php √ºberschrieben ‚Üí DB-Verbindung verloren
- ‚ùå .htaccess besch√§digt (EOF-Delimiter in Datei) ‚Üí 500 Error
- ‚ùå Mehrere Wiederherstellungsversuche schlugen fehl
- ‚ùå ~3 Stunden Downtime

**Recovery:**
- ‚úÖ `git reset --hard fef6dae` zur√ºck zum letzten funktionierenden Stand
- ‚úÖ config.php manuell wiederhergestellt
- ‚úÖ .htaccess EOF-Problem behoben
- ‚úÖ Website wieder online
- ‚úÖ Admin-Zugang wiederhergestellt

**Lessons Learned dokumentiert in:** `docs/08-deployment-ops.md`

### 10. Sicheres Production Deployment (2. Versuch)

**Befolgte Schritte:**
1. ‚úÖ **Backups erstellt** (config.php, .htaccess)
2. ‚úÖ **Git Status gepr√ºft** vor √Ñnderungen
3. ‚úÖ **Cherry-pick statt Pull** (nur HTML-Signatur Commit)
4. ‚úÖ **Config sofort wiederhergestellt** nach Git-Operationen
5. ‚úÖ **Email-Verzeichnis erstellt** (`src/assets/images/email/`)
6. ‚úÖ **Logo kopiert** (logo-square.svg)
7. ‚úÖ **Tests durchgef√ºhrt** (Hauptseite, Admin, Error-Logs)
8. ‚úÖ **Production branch lokal synchronisiert**
9. ‚úÖ **Zu GitHub gepusht**

**Ergebnis:**
- ‚úÖ Website online und funktionsf√§hig
- ‚úÖ Admin-Zugang verf√ºgbar
- ‚úÖ HTML-Signatur Feature deployed
- ‚úÖ Keine Fehler in Logs
- ‚úÖ Git-Branches synchronisiert

**Git Commits:**
```
4b68183 - Feature: HTML-Signatur mit Logo (verbessert)
e719977 - Merge: HTML-Signatur mit Logo (Production Deployment)
```

### Neue Deployment-Regeln (ZWINGEND)

**VOR jedem Production-Deployment:**
1. Backups erstellen (config.php, .htaccess, Datenbank)
2. Git status pr√ºfen
3. Git stash f√ºr lokale √Ñnderungen
4. Git diff pr√ºfen bevor Pull

**W√ÑHREND Deployment:**
1. Cherry-pick ODER Pull (niemals beides gleichzeitig)
2. SOFORT config.php wiederherstellen
3. .htaccess auf EOF/HEREDOC-Fehler pr√ºfen

**NACH Deployment:**
1. Hauptseite testen
2. Admin-Login testen
3. Error-Logs pr√ºfen
4. Git-Branches synchronisieren

**Gesch√ºtzte Dateien (.gitignore):**
- `src/core/config.php`
- `.htaccess`
- `src/core/Security.php`

---

## Session 3 (21:00 Uhr): Kalender-Bugfixes

### 11. PHP 8.x Deprecation Warning - substr() mit null

**Problem:** Bei umgebuchten Terminen (z.B. Sabine H.) trat PHP 8.x Deprecation Warning auf:
```
Deprecated: substr(): Passing null to parameter #1 ($string) of type string is deprecated
in booking-week.php on line 230
```

**Ursache:** Umgebuchte Termine k√∂nnen `customer_lastname = NULL` oder `booking_time = NULL` haben

**L√∂sung:** Null-safe ternary operators
```php
// Vorher
<?= substr($booking['customer_lastname'], 0, 1) ?>
<?= substr($booking['booking_time'], 0, 5) ?>

// Nachher
<?= $booking['customer_lastname'] ? substr($booking['customer_lastname'], 0, 1) : '' ?>
<?= $booking['booking_time'] ? substr($booking['booking_time'], 0, 5) : '??:??' ?>
```

**Ge√§nderte Dateien:**
- `src/admin/booking-week.php` (Zeilen 227, 230, 260, 263, 310)
- `src/admin/booking-calendar.php` (Zeile 188)
- `src/admin/booking-calendar-v2.php` (Zeile 316)

### 12. Kalender-Darstellung verbessert

**Probleme:**
1. ‚ùå Stornierte Termine werden in gr√ºn angezeigt (sollten ausgeblendet sein)
2. ‚ùå Pending-Termine: Gelb zu hell (#ffc107) + wei√üe Schrift = schlecht lesbar
3. ‚ùå Confirmed-Termine: Gr√ºn zu hell (#28a745)

**L√∂sung:**

**1. Stornierte Termine ausblenden:**
```php
foreach ($dayBookings as $booking):
    if ($booking['status'] === 'cancelled') continue; // NEU
```

**2. Dunklere Farben + besserer Kontrast:**
```php
$bgColor = '#1e7e34'; // confirmed (vorher: #28a745)
$textColor = '#ffffff';
if ($booking['status'] === 'pending') {
    $bgColor = '#d39e00'; // vorher: #ffc107 (zu hell)
    $textColor = '#000000'; // schwarz statt wei√ü
}
```

**3. Legende aktualisiert:**
```html
<span><span class="legend-box" style="background: #1e7e34;"></span> Best√§tigt</span>
<span><span class="legend-box" style="background: #d39e00;"></span> Ausstehend</span>
<span style="opacity: 0.7;"><em>(Stornierte ausgeblendet)</em></span>
```

**Betroffene Dateien:**
- ‚úÖ `src/admin/booking-week.php` (Wochenkalender) - Zeilen 129-134, 278-294
- ‚úÖ `src/admin/booking-calendar-v2.php` (Monatskalender) - Zeilen 227-232, 293-307

**Wichtige Erkenntnis:**
- Router (`src/router.php` Zeile 164) l√§dt `booking-calendar-v2.php`, NICHT `booking-calendar.php`!
- Erste √Ñnderungen in falscher Datei (booking-calendar.php) ‚Üí keine Wirkung
- Nach Korrektur in booking-calendar-v2.php ‚Üí funktioniert

### 13. Email-Signatur HTML-Rendering

**Problem:** Emails kamen mit Plaintext-Signaturen an, nicht HTML mit Logo

**Ursache:** Email-Templates werden als Plaintext in DB gespeichert, aber `EmailService.php` konvertierte sie nicht zu HTML

**L√∂sung in `src/core/EmailService.php` (Zeilen 53-62):**
```php
// Vorher
$fullBodyHtml = $body . "\n\n" . $signature['html'];
$fullBodyPlain = strip_tags($body) . "\n\n" . $signature['plaintext'];

// Nachher - Plaintext-Template zu HTML konvertieren
$bodyHtml = nl2br(htmlspecialchars($body, ENT_QUOTES, 'UTF-8'));
$fullBodyHtml = $bodyHtml . "\n\n" . $signature['html'];
$fullBodyPlain = $body . "\n\n" . $signature['plaintext'];
```

**Zus√§tzlich:** Admin-Kontaktformular-Mails bekommen jetzt auch Signatur (Zeilen 687, 689)

**Testerin-Feedback:** ‚úÖ "Kundenmail auch nun mit html Signatur angekommen ist"

### Production Deployment

**Durchgef√ºhrt:**
1. ‚úÖ Backups erstellt (config.php, .htaccess)
2. ‚úÖ Git stash f√ºr lokale √Ñnderungen
3. ‚úÖ Git pull origin production ‚Üí "Already up to date" (war bereits aktuell)
4. ‚úÖ Config.php wiederhergestellt
5. ‚úÖ Tests: HTTP 200, keine Fehler in Logs
6. ‚úÖ Git-Branches synchronisiert (master ‚Üê production)

**Git Commits:**
```
1035794 - Fix: Monatskalender - Stornierte ausblenden + dunklere Farben
b4ea866 - Fix: Wochenkalender - substr() null-safe + Farben + Email-Signatur HTML
```

### Gel√∂ste Probleme

1. ‚úÖ PHP 8.x Deprecation Warnings (substr mit null)
2. ‚úÖ Stornierte Termine ausgeblendet (Wochen- + Monatskalender)
3. ‚úÖ Pending-Farbe dunkler (#d39e00) mit schwarzer Schrift
4. ‚úÖ Confirmed-Farbe dunkler (#1e7e34)
5. ‚úÖ Email-Signaturen als HTML (mit Logo) statt Plaintext
6. ‚úÖ Router-Confusion aufgekl√§rt (booking-calendar-v2.php vs booking-calendar.php)

### Lessons Learned

1. **Router-Mapping pr√ºfen** - Erst checken welche Datei tats√§chlich geladen wird!
2. **Lokal testen VOR Production** - Verhindert "es hat sich nichts ge√§ndert"-Situationen
3. **Grep zur Verifikation nutzen** - Code-√Ñnderungen in Datei best√§tigen
4. **Deployment-Checkliste befolgen** - Backups, Stash, Config-Restore funktioniert
5. **Null-Safe PHP 8.x** - Immer ternary bei `substr()` wenn Werte null sein k√∂nnen

---

## Session 4 (21:30 Uhr): config.php Security-Fix

### 14. config.php aus Git-Tracking entfernt

**Problem:** `config.php` wurde trotz `.gitignore` bei jedem `git pull` √ºberschrieben
- War fr√ºher mal committed ‚Üí blieb im Git-Index
- `.gitignore` wirkt nur f√ºr neue Dateien, nicht f√ºr bereits getrackte

**Resultat:**
- Bei JEDEM Production-Deployment wurde config.php √ºberschrieben
- Manuelles Restore nach jedem Pull n√∂tig
- Mehrfache Incidents mit DB-Verbindungsverlust

**L√∂sung:**
```bash
# Lokal durchgef√ºhrt:
git rm --cached src/core/config.php
git add src/core/config.php.example
git commit -m "Security: config.php aus Git-Tracking entfernt"
git push origin master && production
```

**Einmaliges Production-Update (durchgef√ºhrt):**
```bash
# 1. Backup erstellen
cp src/core/config.php src/core/config.php.PERMANENT-BACKUP-$(date +%Y%m%d-%H%M%S)

# 2. Git stash (config.php sch√ºtzen)
git stash push -m "Config backup before pull" src/core/config.php

# 3. Git pull (Git versucht config.php zu l√∂schen)
git pull origin production

# 4. Config wiederherstellen
git stash pop

# 5. Merge-Konflikt in config.php.example l√∂sen
git checkout --theirs src/core/config.php.example
git add src/core/config.php.example
git reset HEAD src/core/config.php.example

# 6. Stashes aufr√§umen
git stash drop stash@{0}  # 3x ausgef√ºhrt

# 7. Pr√ºfen: config.php NICHT in git status
git status src/core/config.php
# ‚Üí "nothing to commit, working tree clean" ‚úÖ
```

**config.php.example erstellt:**
- Template-Datei ohne sensible Daten
- Platzhalter: `YOUR_DATABASE_NAME`, `YOUR_HELLOCASH_API_KEY`
- Anleitung im Header

**Ergebnis:**
- ‚úÖ config.php wird NIE MEHR von Git √ºberschrieben
- ‚úÖ Kein manuelles Restore mehr n√∂tig
- ‚úÖ Production-Config bleibt immer erhalten
- ‚úÖ Schnellere und sicherere Deployments

**Git Commit:**
```
61682ed - Security: config.php aus Git-Tracking entfernt
```

### Neues Deployment-Protokoll (ab sofort)

**VOR Deployment:**
```bash
ssh auf Production
cd /home/www/doc/28552/dcp285520007/pc-wittfoot.de/www
cp .htaccess .htaccess.backup-$(date +%Y%m%d-%H%M%S)  # NUR noch .htaccess!
git status  # config.php sollte NICHT auftauchen
```

**W√ÑHREND Deployment:**
```bash
git pull origin production  # config.php wird NICHT √ºberschrieben!
cat .htaccess | grep -i "EOF\|ENDSSH"  # Pr√ºfe .htaccess
curl -I https://pc-wittfoot.de/ | head -3
```

**NACH Deployment:**
```bash
tail -10 logs/error.log
exit
```

**Vorteile:**
- üöÄ **Schneller:** Ein Schritt weniger (kein config.php-Restore)
- üîí **Sicherer:** Production-Credentials nie in Git
- üéØ **Einfacher:** Kein versehentliches √úberschreiben mehr m√∂glich

### Direkte Server-Edits: Konflikt-Risiken

**Frage:** "Gibt es Konflikte wenn ich Rechtschreibfehler direkt auf dem Server korrigiere?"

**Antwort:** JA, bei den meisten Dateien! ‚ö†Ô∏è

**Konflikt-Risiko:**
- ‚ùå PHP-Dateien (*.php) ‚Üí Git-Konflikt bei n√§chstem Pull
- ‚ùå CSS/JS ‚Üí Git-Konflikt bei n√§chstem Pull
- ‚ùå Templates ‚Üí Git-Konflikt bei n√§chstem Pull
- ‚úÖ config.php ‚Üí KEIN Konflikt (jetzt in .gitignore!)
- ‚úÖ .htaccess ‚Üí Kein Konflikt (in .gitignore)
- ‚úÖ logs/error.log ‚Üí Kein Konflikt (in .gitignore)

**Empfehlung:**
- ‚úÖ **IMMER lokal bearbeiten** ‚Üí committen ‚Üí deployen
- ‚ö†Ô∏è **Nur f√ºr schnelle Typo-Fixes direkt auf Server**, dann SOFORT lokal nachziehen

**Bei Konflikten:**
```bash
git stash  # Server-√Ñnderungen sichern
git pull   # Neue Version holen
git stash pop  # √Ñnderungen anwenden ‚Üí Konflikt-Marker erscheinen
# ‚Üí Manuell l√∂sen und committen
```

### Dokumentation aktualisiert

**Dateien:**
- `docs/08-deployment-ops.md` - Neue Sektion "config.php aus Git-Tracking entfernt"
  - Einmaliges Production-Update (Schritt-f√ºr-Schritt)
  - Neues Deployment-Protokoll (vereinfacht)
  - Direkte Server-Edits Workflow (3 Optionen)
  - Konflikt-Handling
  - Vorteile des neuen Systems

## ‚è≠Ô∏è N√§chste Schritte

1. ‚úÖ HTML-Signatur auf Production deployed
2. ‚úÖ Kalender-Bugs gefixt (storniert, Farben, PHP 8.x)
3. ‚úÖ config.php Security-Fix (aus Git-Tracking entfernt)
4. ‚úÖ Dokumentation aktualisiert (Deployment-Ops + Session Log)
5. Email-Signatur im Admin bearbeiten und Logo hochladen
6. Test-Email senden zur Verifikation
7. Datenschutzerkl√§rung erstellen
8. Blog-System √ºberarbeiten
9. Shop-Phase vorbereiten
