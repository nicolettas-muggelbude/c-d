# Session Log: 2026-01-11 - Production Deployment & Performance-Optimierung

## üéØ Ziel der Session
Production Deployment abschlie√üen und Performance-Probleme beheben

## ‚úÖ Erreichte Meilensteine

### 1. Datenbank 1:1 Migration
**Problem:** Lokale Datenbank hatte 22 Tabellen, Production nur teilweise importiert
**L√∂sung:**
- Export-Script erstellt: `export-database-php.php` (da mysqldump nicht verf√ºgbar)
- Vollst√§ndiger Export: 22 Tabellen, 314 KB
- Datei: `database/production-full-dump.sql`
- Import auf Production erfolgreich

**Dateien:**
- `/export-database-php.php`
- `/database/production-full-dump.sql`

### 2. Apache .htaccess Konfiguration
**Problem:** CSS nicht geladen, Navigation funktionierte nicht
**L√∂sung:**
```apache
RewriteEngine On

# HTTPS Redirect
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Statische Assets ZUERST
RewriteRule ^assets/(.*)$ src/assets/$1 [L]
RewriteRule ^favicon\.(.*)$ src/favicon.$1 [L]

# Router NUR f√ºr nicht-existierende Dateien
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ src/router.php?route=$1 [L,QSA]

DirectoryIndex src/router.php
Options -Indexes
```

**Kritische Fixes:**
- `?route=$1` Parameter hinzugef√ºgt
- RewriteCond Zeilen vor Router-Regel
- Assets-Pfade VOR Router-Regel

### 3. Content Security Policy
**Problem:** CSS von www.pc-wittfoot.de blockiert, wenn Seite ohne www aufgerufen
**L√∂sung:** CSP erweitert in `src/core/Security.php`
```php
header("Content-Security-Policy: default-src 'self' http://pc-wittfoot.de https://pc-wittfoot.de http://www.pc-wittfoot.de https://www.pc-wittfoot.de; ...");
```

**BASE_URL ge√§ndert:**
- Von: `https://www.pc-wittfoot.de`
- Zu: `https://pc-wittfoot.de` (ohne www)

### 4. Performance-Optimierung: HelloCash Async
**Problem:** Buchungs-Best√§tigung dauerte 8-9 Sekunden (HelloCash API Call blocking)

**Versuchte L√∂sungen:**
1. ‚ùå `fastcgi_finish_request()` - nicht verf√ºgbar auf Server
2. ‚ùå `ob_end_flush() + flush()` - trotzdem 10 Sekunden

**Finale L√∂sung:** Asynchroner Cronjob
- HelloCash-Sync aus `src/api/booking.php` entfernt
- Buchung wird mit `hellocash_customer_id = NULL` gespeichert
- Cronjob synchronisiert nachtr√§glich

**Ergebnis:** Buchungs-Response < 1 Sekunde ‚úÖ

### 5. Button-Disable gegen Doppelbuchungen
**Problem:** W√§hrend 8-Sekunden-Wartezeit konnten User mehrfach klicken

**L√∂sung in `src/pages/termin.php` (Zeile 945+):**
```javascript
document.getElementById('booking-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Button deaktivieren
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Wird gebucht...';

    // ... Booking Logic ...

    // Bei Fehler wieder aktivieren
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
});
```

### 6. HelloCash Cronjob Implementation
**Datei:** `/cronjobs/sync-hellocash.php`

**Features:**
- Findet alle Buchungen ohne HelloCash-ID
- Limit 50 Buchungen pro Lauf
- Ruft `HelloCashClient::findOrCreateUser()` auf
- Speichert HelloCash-ID in Buchung
- Logging mit Timestamps
- Exit Code 0 bei Erfolg, 1 bei Fehlern
- 0.2s Pause zwischen API-Calls (API-Rate-Limit)

**Crontab-Eintrag:**
```cron
*/5 * * * * /usr/bin/php /home/www/doc/28552/dcp285520007/pc-wittfoot.de/www/cronjobs/sync-hellocash.php >> /home/www/doc/28552/dcp285520007/pc-wittfoot.de/www/logs/cronjob.log 2>&1
```

**Fixes:**
- Require-Pfad: `Database.php` ‚Üí `database.php` (lowercase)
- Kommentar-Block: Crontab-Syntax entfernt (wurde als PHP geparst)

### 7. Weitere Bug-Fixes
- ‚úÖ Email-Template Preview 404 ‚Üí `src/test-email-preview.php` auf Server kopiert
- ‚úÖ Admin-Login "Ung√ºltige Anmeldedaten" ‚Üí Password-Hash neu generiert
- ‚úÖ config.php mit Dev-Settings ‚Üí `config.production.php` kopiert
- ‚úÖ .htaccess deleted nach `git reset` ‚Üí manuell neu erstellt

## üìä Performance-Verbesserung

| Metrik | Vorher | Nachher |
|--------|--------|---------|
| Buchungs-Response | 8-9 Sekunden | < 1 Sekunde |
| HelloCash-Sync | Blocking | Async (Cronjob) |
| Doppelbuchungen | M√∂glich | Verhindert |

## üîß Git Workflow

```bash
# Lokale √Ñnderungen
git add .
git commit -m "Message"
git push origin master

# Production Branch
git checkout production
git merge master
git push origin production
git checkout master

# Production Server
ssh dcp285520007@www116.c.artfiles.de
cd /home/www/doc/28552/dcp285520007/pc-wittfoot.de/www
git pull origin production
```

## üöÄ Production Server Details

**Host:** www116.c.artfiles.de
**User:** dcp285520007
**Web Root:** `/home/www/doc/28552/dcp285520007/pc-wittfoot.de/www`
**Database:** sql116.c.artfiles.de / db285520001
**Live URL:** https://pc-wittfoot.de

## üìù Wichtige Erkenntnisse

1. **Heredoc via SSH funktioniert nicht zuverl√§ssig** ‚Üí Besser: `echo "line" >> file`
2. **Git-Workflow nutzen statt manuelles Kopieren** ‚Üí Schneller und sicherer
3. **Vollst√§ndige DB-Migration statt piecemeal** ‚Üí Verhindert Inkonsistenzen
4. **Performance √ºber Completeness** ‚Üí Fast response wichtiger als synchroner Sync
5. **BASE_URL ohne www** ‚Üí Einfacher f√ºr CSP und weniger Redirects

## üêõ Gel√∂ste Probleme

1. ‚úÖ Database Schema incomplete
2. ‚úÖ CSS MIME-Type errors
3. ‚úÖ Navigation links not working
4. ‚úÖ CSP blocking assets
5. ‚úÖ Booking performance (8-9s)
6. ‚úÖ Double-booking possible
7. ‚úÖ HelloCash sync blocking
8. ‚úÖ Email template preview 404
9. ‚úÖ Admin login broken
10. ‚úÖ Config overwritten by git

## üìã Offene Punkte

- [ ] Vollst√§ndiges Production-Testing (Buchung, Email, Mobile)
- [ ] Datenschutzerkl√§rung erstellen
- [ ] Blog-System √ºberarbeiten
- [ ] PayPal-Integration
- [ ] Shop f√ºr Production vorbereiten

## üéì Lessons Learned

### Was gut lief:
- Git-basierter Deployment-Workflow
- Schnelle Problemidentifikation
- Pragmatische L√∂sungen (async statt blocking)

### Was verbessert werden kann:
- Fr√ºher vollst√§ndige DB-Migration
- Bessere SSH-Tool-Kompatibilit√§t testen
- Production-Checklist vor Deployment

## üì¶ Ge√§nderte Dateien (Commits)

```
11dd86d - Fix: Cronjob require-Pfad database.php (lowercase)
9f88611 - Performance: HelloCash-Sync asynchron per Cronjob
6c3f6e2 - Fix: Button-Disable bei Buchung gegen Doppelbuchungen
... (siehe Git Log)
```

---

## Session 2 (Abend): HTML-Signatur mit Logo

### 8. HTML Email-Signatur Implementation

**Ziel:** Email-Signatur mit Logo-Support und Plaintext-Fallback

**Features:**
- ‚úÖ HTML-Signatur mit `{logo_url}` Platzhalter
- ‚úÖ Automatische Plaintext-Generierung aus HTML (wie Email-Templates)
- ‚úÖ Logo-Auswahl: `logo-square.svg` (Empfohlen)
- ‚úÖ Modal-Vorschau mit iframe (Dark-Mode kompatibel)
- ‚úÖ Nur ein Textarea-Feld (UX-Verbesserung)

**Datenbank-Migration:** `database/migrations/019_email_signature_html.sql`
```sql
ALTER TABLE email_signature
ADD COLUMN signature_html TEXT NULL,
ADD COLUMN signature_plaintext TEXT NULL,
ADD COLUMN logo_filename VARCHAR(255) NULL;
```

**Ge√§nderte Dateien:**
- `src/admin/email-templates.php` - UI und Auto-Plaintext-Generierung
- `src/assets/images/email/logo-square.svg` - Logo f√ºr Email-Signatur
- `docs/08-deployment-ops.md` - Deployment-Lessons dokumentiert

**Lokale Tests:**
- ‚úÖ Migration ausgef√ºhrt
- ‚úÖ Logo wird in Vorschau angezeigt
- ‚úÖ Plaintext wird automatisch generiert
- ‚úÖ Dark-Mode Vorschau funktioniert

### 9. Production Deployment Incident & Recovery

**Was passierte:**
- ‚ùå Erster Deployment-Versuch ging schief (git pull ohne Backup)
- ‚ùå config.php √ºberschrieben ‚Üí DB-Verbindung verloren
- ‚ùå .htaccess besch√§digt (EOF-Delimiter in Datei) ‚Üí 500 Error
- ‚ùå Mehrere Wiederherstellungsversuche schlugen fehl
- ‚ùå ~3 Stunden Downtime

**Recovery:**
- ‚úÖ `git reset --hard fef6dae` zur√ºck zum letzten funktionierenden Stand
- ‚úÖ config.php manuell wiederhergestellt
- ‚úÖ .htaccess EOF-Problem behoben
- ‚úÖ Website wieder online
- ‚úÖ Admin-Zugang wiederhergestellt

**Lessons Learned dokumentiert in:** `docs/08-deployment-ops.md`

### 10. Sicheres Production Deployment (2. Versuch)

**Befolgte Schritte:**
1. ‚úÖ **Backups erstellt** (config.php, .htaccess)
2. ‚úÖ **Git Status gepr√ºft** vor √Ñnderungen
3. ‚úÖ **Cherry-pick statt Pull** (nur HTML-Signatur Commit)
4. ‚úÖ **Config sofort wiederhergestellt** nach Git-Operationen
5. ‚úÖ **Email-Verzeichnis erstellt** (`src/assets/images/email/`)
6. ‚úÖ **Logo kopiert** (logo-square.svg)
7. ‚úÖ **Tests durchgef√ºhrt** (Hauptseite, Admin, Error-Logs)
8. ‚úÖ **Production branch lokal synchronisiert**
9. ‚úÖ **Zu GitHub gepusht**

**Ergebnis:**
- ‚úÖ Website online und funktionsf√§hig
- ‚úÖ Admin-Zugang verf√ºgbar
- ‚úÖ HTML-Signatur Feature deployed
- ‚úÖ Keine Fehler in Logs
- ‚úÖ Git-Branches synchronisiert

**Git Commits:**
```
4b68183 - Feature: HTML-Signatur mit Logo (verbessert)
e719977 - Merge: HTML-Signatur mit Logo (Production Deployment)
```

### Neue Deployment-Regeln (ZWINGEND)

**VOR jedem Production-Deployment:**
1. Backups erstellen (config.php, .htaccess, Datenbank)
2. Git status pr√ºfen
3. Git stash f√ºr lokale √Ñnderungen
4. Git diff pr√ºfen bevor Pull

**W√ÑHREND Deployment:**
1. Cherry-pick ODER Pull (niemals beides gleichzeitig)
2. SOFORT config.php wiederherstellen
3. .htaccess auf EOF/HEREDOC-Fehler pr√ºfen

**NACH Deployment:**
1. Hauptseite testen
2. Admin-Login testen
3. Error-Logs pr√ºfen
4. Git-Branches synchronisieren

**Gesch√ºtzte Dateien (.gitignore):**
- `src/core/config.php`
- `.htaccess`
- `src/core/Security.php`

## ‚è≠Ô∏è N√§chste Schritte

1. ‚úÖ HTML-Signatur auf Production deployed
2. Email-Signatur im Admin bearbeiten und Logo hochladen
3. Test-Email senden zur Verifikation
4. Datenschutzerkl√§rung erstellen
5. Shop-Phase vorbereiten
