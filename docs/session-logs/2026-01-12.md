# Session Log: 2026-01-12 - Kritische Bugfixes: HelloCash, Admin-Login, Blockierte Termine

## üéØ Ziel der Session
Drei kritische Bugs beheben: HelloCash-Synchronisation, Admin-Login-System, und blockierte Termine

## ‚úÖ Erreichte Meilensteine

### 1. HelloCash-Synchronisation: Drei kritische Fehler behoben
**Problem 1:** `SQLSTATE[22007]: Invalid datetime format: 1292 Incorrect time value: '' for column booking_end_time`
- Empty String wurde als Zeitwert √ºbergeben statt NULL
- **L√∂sung:** `!empty()` Check in `src/admin/booking-calendar-v2.php` und `src/admin/admin/booking-calendar-v2.php`

**Problem 2:** `SQLSTATE[42S22]: Column not found: 1054 Unknown column 'hellocash_user_id'`
- Spaltenname falsch: `hellocash_user_id` statt `hellocash_customer_id`
- **L√∂sung:** 4 Dateien korrigiert (beide booking-calendar-v2.php und booking-week.php Varianten)

**Problem 3:** `HelloCash createUser Error: user_surname oder user_company ist erforderlich`
- Cronjob schlug fehl wenn Kunden weder Nachname noch Firma hatten
- **L√∂sung:** Fallback-Platzhalter '.' in `cronjobs/sync-hellocash.php` (Zeile 54-57)

**Ergebnis:** 62 Buchungen erfolgreich synchronisiert (0 Fehler)

**Betroffene Dateien:**
```
src/admin/booking-calendar-v2.php
src/admin/admin/booking-calendar-v2.php
src/admin/booking-week.php
src/admin/admin/booking-week.php
cronjobs/sync-hellocash.php
```

**Commit:** `2874524 Fix: HelloCash-Synchronisation - Drei kritische Fehler behoben`

---

### 2. Admin-Login-System: Komplette Neueinrichtung
**Problem:** Nach Deployment funktionierte Admin-Login nicht mehr
- Redirect-Loop: `/admin` ‚Üí `/admin/login.php` ‚Üí `/admin/login.php` (endlos)
- Fehlermeldung: "Ung√ºltiger Sicherheitstoken"
- Sessions wurden nicht gespeichert
- Rate Limiting blockierte selbst valide Login-Versuche

#### Fix 1: Session Save Path
**Problem:** `session_start(): open(...) failed: No such file or directory`
- PHP konnte Sessions nicht im Temp-Verzeichnis speichern
- **L√∂sung in `src/core/config.php` (Zeile 64):**
```php
// Session save path absolut setzen
ini_set('session.save_path', '/home/www/doc/28552/dcp285520007/pc-wittfoot.de/www/logs');
```

#### Fix 2: Redirect-Loop beseitigt
**Problem:** Router interpretierte `/admin/login.php` als `param='login.php'` statt Route 'login'
- **L√∂sung in `src/core/helpers.php` (Zeile 162):**
```php
// Von: redirect(BASE_URL . '/admin/login.php');
// Zu:  redirect(BASE_URL . '/admin/login');
```

#### Fix 3: Admin-Passwort zur√ºckgesetzt
**Problem:** Password-Hash stimmte nicht √ºberein
- **L√∂sung:** Passwort auf 'admin123' zur√ºckgesetzt via SQL:
```sql
UPDATE admins SET password = '$2y$10$T7xjJZ...' WHERE username = 'admin';
```

#### Fix 4: Rate Limiting tempor√§r deaktiviert
**Problem:** `rate_limits` Tabelle existiert nicht, Code pr√ºft sie aber
- User wurde auf Seitenaufruf geblockt: "Vor√ºbergehend gesperrt"
- **L√∂sung:** Rate Limiting Code in `src/admin/login.php` auskommentiert

**Ergebnis:** Admin-Login funktioniert vollst√§ndig ‚úÖ

**Betroffene Dateien:**
```
src/core/config.php (Session Path)
src/core/helpers.php (Redirect Fix)
src/admin/login.php (Rate Limiting deaktiviert)
database/admins (Password-Hash)
```

**Commits:**
- `a4f58b3 Fix: Admin-Login Redirect zu /admin/login statt /admin/login.php`
- `aa74584 Docs: Session 2026-01-12 - Admin-Login Session-Problem dokumentiert`

---

### 3. Admin-Blockierungen: Kritischer Buchungsfehler behoben
**Problem:** "Durch Admin gesperrte Termine sind nicht gesperrt. Kunden haben dennoch auf den gesperrten Zeitraum buchen k√∂nnen."

**Root Cause Analyse:**
Alle drei API-Endpoints pr√ºften nur `booking_type = 'fixed'` und ignorierten `booking_type = 'blocked'`:

1. **`src/api/available-slots.php` (Zeile 100)**
   - Frontend-Verf√ºgbarkeitscheck ignorierte blockierte Slots
   - Slots wurden als "verf√ºgbar" angezeigt obwohl Admin sie gesperrt hatte

2. **`src/api/fully-booked-dates.php` (Zeile 67)**
   - Blockierte Tage wurden nicht als ausgebucht markiert
   - Kalender zeigte gesperrte Tage als buchbar an

3. **`src/api/booking.php` (Zeile 162)**
   - Server-seitige Validierung pr√ºfte keine Blockierungen
   - Kunden konnten Buchung trotz Admin-Sperre abschlie√üen

**L√∂sung:** SQL-Queries in allen 3 Dateien angepasst:
```php
// Vorher:
AND booking_type = 'fixed'

// Nachher:
AND booking_type IN ('fixed', 'blocked')
```

**Ergebnis:** Admin-Blockierungen verhindern jetzt zuverl√§ssig Kundenbuchungen ‚úÖ

**Betroffene Dateien:**
```
src/api/available-slots.php (Zeile 100 + Kommentar)
src/api/fully-booked-dates.php (Zeile 67 + Kommentar)
src/api/booking.php (Zeile 162 + Kommentar)
```

**Commit:** `4e91e24 Fix: Admin-Blockierungen verhindern jetzt Kundenbuchungen`

**Changelog:**
```
- available-slots.php: booking_type IN ('fixed', 'blocked')
- fully-booked-dates.php: booking_type IN ('fixed', 'blocked')
- booking.php: Server-seitige Validierung pr√ºft jetzt auch 'blocked'
```

---

## üìù Technische Details

### Booking Types im System
```php
'fixed'   // Feste Kundentermine (Di-Fr 11:00-17:00)
'walkin'  // "Ich komme vorbei" (Di-Fr 14:00-16:00, Sa 12:00-16:00)
'blocked' // Admin-Blockierung (verhindert Kundenbuchungen)
```

### Validierungs-Layer
1. **Frontend:** `available-slots.php` - Zeigt verf√ºgbare Slots
2. **Kalender:** `fully-booked-dates.php` - Markiert ausgebuchte Tage
3. **Backend:** `booking.php` - Server-seitige Doppelbuchungspr√ºfung

Alle drei Layer m√ºssen `'blocked'` Termine ber√ºcksichtigen!

---

## üöÄ Deployment

### Production-Deployment
```bash
# Auf Production Server (SSH)
cd /home/www/doc/28552/dcp285520007/pc-wittfoot.de/www
git pull origin master

# Oder via Git:
git checkout production
git merge master
git push origin production
```

### Test-Schritte
1. ‚úÖ Admin-Login testen
2. ‚úÖ Termin durch Admin blockieren
3. ‚úÖ Als Kunde versuchen auf gesperrten Slot zu buchen
4. ‚úÖ Erwartung: Slot nicht verf√ºgbar / "Bereits ausgebucht"

---

### 4. Blockierungs-Zeitspannen: Follow-up Bugfix
**Problem nach Deployment:** "Ich habe am 13.01. einen Block von 11 bis 13:00 Uhr. Kunde kann nicht 11:00 Uhr buchen, jedoch 12:00 Uhr"

**Root Cause:**
Eine Blockierung von 11:00-13:00 hat:
- `booking_time = 11:00:00`
- `booking_end_time = 13:00:00`

Die vorherige L√∂sung pr√ºfte nur ob `booking_time` EXAKT dem Slot entspricht:
- 11:00 Uhr = geblockt ‚úÖ (booking_time matched)
- 12:00 Uhr = NICHT geblockt ‚ùå (booking_time matched nicht)

**L√∂sung:** Zeitspannen-Logik implementiert

**`src/api/available-slots.php`:**
```php
// Separate Queries f√ºr fixed (exact match) und blocked (range check)
$blockings = $db->query("SELECT booking_time, booking_end_time FROM bookings WHERE booking_type = 'blocked'...");

foreach ($slots as $slot) {
    foreach ($blockings as $blocking) {
        $blockStart = substr($blocking['booking_time'], 0, 5);
        $blockEnd = $blocking['booking_end_time'] ? substr($blocking['booking_end_time'], 0, 5) : null;

        // Slot ist geblockt wenn: slot >= blockStart UND slot < blockEnd
        if ($slot >= $blockStart && ($blockEnd === null || $slot < $blockEnd)) {
            $bookedCount = $maxBookingsPerSlot; // Komplett blocken
            break;
        }
    }
}
```

**`src/api/booking.php`:**
```php
// Zeitspannen-Check in SQL
$blockingSql = "SELECT COUNT(*) as count
                FROM bookings
                WHERE booking_date = :date
                AND booking_type = 'blocked'
                AND TIME_FORMAT(booking_time, '%H:%i') <= :time
                AND (booking_end_time IS NULL OR TIME_FORMAT(booking_end_time, '%H:%i') > :time)";
```

**`src/api/fully-booked-dates.php`:**
- Komplett neu geschrieben: Berechnet f√ºr jeden Tag wie viele Slots tats√§chlich belegt sind
- Blockierungen werden expandiert zu allen Slots in ihrer Zeitspanne
- Tag ist ausgebucht wenn: `bookedSlotsCount >= slotsPerDay`

**Ergebnis:** Blockierung 11:00-13:00 blockt jetzt:
- 11:00 ‚úÖ
- 12:00 ‚úÖ
- 13:00 bleibt frei (Ende ist exklusiv)

**Betroffene Dateien:**
```
src/api/available-slots.php (Zeitspannen-Check in PHP)
src/api/booking.php (Zeitspannen-Check in SQL)
src/api/fully-booked-dates.php (Komplett neu: Slot-basierte Berechnung)
```

**Commit:** `ff0f5ae Fix: Blockierungs-Zeitspannen werden jetzt korrekt ber√ºcksichtigt`

---

### 5. Walk-in Tage f√§lschlicherweise als fully booked markiert
**Problem nach Deployment:** "Der 21.01.26 ist von 11:00 bis 13:00 Uhr geblockt. Jedoch kann auch am Nachmittag kein 'Ich komme vorbei' gebucht werden."

**Symptom:** Walk-in Tage (Di-Sa) waren im Kalender ausgegraut wenn nur die Fixed-Termin-Slots voll/geblockt waren.

**Root Cause Analyse:**

1. **System-Architektur:**
   - Fixed Termine: 11:00-13:00 (2 Slots, aus Settings)
   - Walk-in Termine: 14:00-17:00 (3 Slots, hardcoded)
   - Walk-ins werden per Modulo unbegrenzt verteilt

2. **Bug in `fully-booked-dates.php`:**
   ```php
   // Problem: Nutzt nur Fixed-Termin Settings
   $slotsPerDay = 2; // Nur 11:00, 12:00
   $maxBookingsPerDay = 2;

   // Blockierung 11:00-13:00 blockt beide Slots ‚Üí 2/2 = fully booked
   if ($bookedSlotsCount >= $slotsPerDay) {
       $fullyBookedDates[] = $date; // Ganzer Tag ausgegraut!
   }
   ```

3. **Walk-in Slots wurden komplett ignoriert:**
   - Nachmittags-Slots (14:00-17:00) existieren nicht in den Settings
   - API markierte Tag als voll obwohl Walk-ins buchbar waren
   - Kunde konnte Datum nicht anklicken

**API-Test zeigte das Problem:**
```bash
curl "https://pc-wittfoot.de/api/fully-booked-dates?weeks=4"
# Ausgabe: "2026-01-21" war in fully_booked_dates obwohl Walk-ins frei
```

**L√∂sung:** Walk-in Tage (Di-Sa) nie als fully booked markieren

```php
// Neue Logik in fully-booked-dates.php
$dateObj = new DateTime($date);
$dayOfWeek = (int)$dateObj->format('N'); // 1=Mo, 2=Di, ..., 7=So

// Walk-ins sind m√∂glich: Di-Sa (2-6)
$walkinPossible = ($dayOfWeek >= 2 && $dayOfWeek <= 6);

// Tag nur als fully booked markieren wenn:
// - Alle Fixed-Slots voll UND
// - Keine Walk-ins m√∂glich (So, Mo)
if ($bookedSlotsCount >= $slotsPerDay && !$walkinPossible) {
    $fullyBookedDates[] = $date;
}
```

**Begr√ºndung:**
- Walk-ins haben unbegrenzte Kapazit√§t (Modulo-Verteilung)
- Di-Sa k√∂nnen nie durch Walk-ins "voll" werden
- Nur So+Mo k√∂nnen fully booked sein (keine Walk-ins m√∂glich)

**Ergebnis nach Fix:**
```bash
curl "https://pc-wittfoot.de/api/fully-booked-dates?weeks=4" | grep "2026-01-21"
# Keine Ausgabe ‚Üí 21.01. nicht mehr fully booked ‚úÖ
```

**Betroffene Datei:**
```
src/api/fully-booked-dates.php (Zeile 127-140)
```

**Commit:** `4e736dd Fix: Walk-in Tage nicht als fully booked markieren`

---

### 6. HTTPS-Zertifikat Warnung (False Positive)
**Problem-Meldung:** "Chrome und co meinen das pc-wittfoot.de nicht sicher sei (http)"

**Analyse:**
- Server-Test: `curl -I http://pc-wittfoot.de/` ‚Üí 301 Redirect auf HTTPS ‚úÖ
- `.htaccess` korrekt konfiguriert mit `RewriteEngine On` ‚úÖ
- `BASE_URL` in config.php: `https://pc-wittfoot.de` ‚úÖ

**Test-Ergebnis:**
```
HTTP/1.1 301 Moved Permanently
Location: https://pc-wittfoot.de/
```

**Ursache:** Browser-Cache beim ersten Testort

**L√∂sung:** Keine √Ñnderung n√∂tig
- Test zu Hause: Edge, Brave, Vivaldi ‚Üí Alle OK ‚úÖ
- HTTPS funktioniert einwandfrei
- Kein tats√§chliches Problem

---

### 7. Termintyp-abh√§ngige Kalenderanzeige fehlte (Follow-up)
**Problem nach Walk-in Fix:** "Der 14.01. ist f√ºr feste Termine ausgebucht. Walk in ist unabh√§ngig und kann am 14.01. gebucht werden. Feste Termine k√∂nnen nicht gebucht werden, jedoch in der Datumsauswahl ist der 14. nicht ausgegraut."

**Symptom:** Tage mit vollen Fixed-Slots (11:00-13:00) waren auch bei "Ich komme vorbei" Auswahl nicht ausgegraut, aber sollten bei "Fester Termin" Auswahl ausgegraut sein.

**Root Cause:**
Der vorherige Fix (Bug #5) hatte Walk-in Tage (Di-Sa) pauschal als "nie fully booked" markiert. Das war korrekt f√ºr Walk-ins, aber falsch f√ºr Fixed-Termine!

**Problem:**
1. User w√§hlt **Termintyp BEVOR Datum** (Step 1 ‚Üí Step 2 ‚Üí Step 3)
2. Frontend l√§dt `fully-booked-dates` API beim Page Load ohne Termintyp-Info
3. API wusste nicht ob Fixed oder Walk-in ‚Üí Kompromiss-Logik (zu permissiv)
4. Result: 14.01. nicht ausgegraut, aber keine Fixed-Slots verf√ºgbar ‚Üí User-Verwirrung

**Architektur-Anforderung:**
- **Fixed-Termin gew√§hlt:** Zeige Tage wo Fixed-Slots voll sind als ausgegraut
- **Walk-in gew√§hlt:** Zeige nur So+Mo ausgegraut (Walk-ins unbegrenzt)

**L√∂sung: Termintyp-Parameter f√ºr API**

**Backend (`src/api/fully-booked-dates.php`):**
```php
// Neuer optionaler Parameter
$bookingType = $_GET['booking_type'] ?? null; // 'fixed', 'walkin', oder null

// F√ºr Walk-ins: Alle Tage im Zeitraum generieren (um So+Mo zu markieren)
if ($bookingType === 'walkin') {
    $currentDate = clone $today;
    while ($currentDate < $endDate) {
        $allDates[] = $currentDate->format('Y-m-d');
        $currentDate->modify('+1 day');
    }
}

// Termintyp-abh√§ngige Logik
if ($bookingType === 'fixed') {
    // Tag ist voll wenn alle Fixed-Slots belegt sind
    $isFullyBooked = ($bookedSlotsCount >= $slotsPerDay);

} else if ($bookingType === 'walkin') {
    // Di-Sa sind NIE fully booked (Walk-ins unbegrenzt)
    // Nur So+Mo k√∂nnen fully booked sein
    $isFullyBooked = !$walkinPossible;

} else {
    // DEFAULT: Backward Compatibility
    $isFullyBooked = ($bookedSlotsCount >= $slotsPerDay && !$walkinPossible);
}
```

**Frontend (`src/pages/termin.php`):**
```javascript
// Funktion akzeptiert jetzt bookingType Parameter
async function loadFullyBookedDates(bookingType = null) {
    let url = '<?= BASE_URL ?>/api/fully-booked-dates?weeks=8';
    if (bookingType) {
        url += `&booking_type=${bookingType}`;
    }
    const response = await fetch(url);
    // ...
}

// Bei Schritt 3 (Datumsauswahl) mit Termintyp neu laden
function setupStep3() {
    // ...
    loadFullyBookedDates(formData.booking_type);
    // ...
}
```

**API-Test Ergebnisse:**
```bash
# Fixed-Termine: Viele Tage ausgegraut
curl "https://pc-wittfoot.de/api/fully-booked-dates?weeks=4&booking_type=fixed"
# ‚Üí ["2026-01-13","2026-01-14","2026-01-15","2026-01-16","2026-01-20","2026-01-21","2026-01-26"]

# Walk-ins: Nur So+Mo ausgegraut
curl "https://pc-wittfoot.de/api/fully-booked-dates?weeks=4&booking_type=walkin"
# ‚Üí ["2026-01-12","2026-01-18","2026-01-19","2026-01-25","2026-01-26","2026-02-01","2026-02-02","2026-02-08"]
```

**Test-Ergebnis (Privates Browser-Fenster):**
1. ‚úÖ User w√§hlt "Fester Termin" ‚Üí 14.01. ausgegraut
2. ‚úÖ User geht zur√ºck, w√§hlt "Ich komme vorbei" ‚Üí 14.01. anklickbar
3. ‚úÖ Nur So+Mo ausgegraut bei Walk-ins

**Deployment-Problem:**
- Normale Browser-Fenster zeigten altes Verhalten (JavaScript-Cache)
- L√∂sung: Hard Reload `Strg + Shift + R` oder Privates Fenster

**Betroffene Dateien:**
```
src/api/fully-booked-dates.php (Termintyp-Parameter, erweiterte Logik)
src/pages/termin.php (loadFullyBookedDates mit Parameter, setupStep3 ruft mit Typ auf)
```

**Commit:** `03c92e1` Fix: Termintyp-abh√§ngige Kalenderanzeige implementiert

---

## üêõ Bekannte Probleme

### Rate Limiting Tabelle fehlt
- `rate_limits` Tabelle existiert nicht in Datenbank
- Code versucht sie zu nutzen
- **Workaround:** Rate Limiting tempor√§r deaktiviert
- **TODO:** Entweder Tabelle erstellen oder Feature dauerhaft entfernen

---

## üìä Session-Statistik

- **Bugs behoben:** 13 (3x HelloCash, 4x Admin-Login, 4x Blockierungs-System, 1x Walk-in, 1x HTTPS False Positive)
- **Commits:** 8
- **Dateien ge√§ndert:** 14
- **Deployment:** Production (deployed & tested ‚úÖ)
- **Kritikalit√§t:** KRITISCH (Buchungssystem-Sicherheit - Kunden konnten gesperrte Termine buchen)
- **Session-Dauer:** ~10 Stunden (inkl. vorheriger Session nach Terminal-Crash)

---

## üîó Related Issues

- HelloCash API: Validierung von Kundendaten
- Session Management: PHP ini_set f√ºr custom paths
- Router-System: Trailing `.php` Probleme
- Doppelbuchungs-Pr√§vention: Multi-Layer Validierung
- Zeitspannen-Logik: Range Checks f√ºr Blockierungen
- Walk-in System: Modulo-basierte unbegrenzte Buchungen
- Termintyp-abh√§ngige Kalenderlogik: API-Parameter f√ºr dynamisches UI
- Browser-Caching: JavaScript Cache erfordert Hard Reload nach Deployment

---

## üìã Alle Commits dieser Session

1. `2874524` Fix: HelloCash-Synchronisation - Drei kritische Fehler behoben
2. `a4f58b3` Fix: Admin-Login Redirect zu /admin/login statt /admin/login.php
3. `aa74584` Docs: Session 2026-01-12 - Admin-Login Session-Problem dokumentiert
4. `4e91e24` Fix: Admin-Blockierungen verhindern jetzt Kundenbuchungen
5. `ff0f5ae` Fix: Blockierungs-Zeitspannen werden jetzt korrekt ber√ºcksichtigt
6. `4e736dd` Fix: Walk-in Tage nicht als fully booked markieren
7. `22ed00e` Docs: Session 2026-01-12 - Blockierungs-System komplett √ºberarbeitet
8. `03c92e1` Fix: Termintyp-abh√§ngige Kalenderanzeige implementiert
9. Finale Dokumentation (dieser Commit)
