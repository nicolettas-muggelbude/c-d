# Session-Log: 2026-01-20

## Blog-Editor: Upload & Markdown Fixes

### Problembeschreibung

Mehrere kritische Probleme im Blog-Editor:

1. **Bild-Upload funktionierte nicht**
   - Upload-Endpoint gab HTML statt JSON zurück
   - Bilder wurden hochgeladen, aber nicht auf Server gespeichert
   - Bildergalerie zeigte nur Dateinamen statt Thumbnails

2. **Pattern-Validierung Fehler**
   - Browser-Fehler: "cannot be checked because pattern is not a valid regexp"
   - HTML5 `/v` Flag zu strikt für Bindestrich in Zeichenklassen

3. **Vorschau-Button funktionierte nicht**
   - Klick auf "Vorschau anzeigen" zeigte Admin-Dashboard statt Markdown-Preview

4. **Markdown-Rendering Probleme**
   - Listen zeigten keine Bullets/Nummern, nur Einrückung
   - Einzelne Zeilenumbrüche wurden ignoriert
   - Nur doppelte Zeilenumbrüche erzeugten Absätze

5. **Favicon fehlte**
   - Nur Firefox zeigte SVG-Favicon
   - Chrome/Edge benötigen .ico Format

---

## Lösungen

### 1. Blog-Bild-Upload: Router-Route hinzugefügt

**Problem:** `/admin/upload-image.php` wurde vom Router nicht erkannt.

**Datei:** `src/router.php`

**Änderung:**
```php
} elseif ($param === 'upload-image.php' || $param === 'upload-image') {
    require_admin();
    require __DIR__ . '/admin/upload-image.php';
} elseif ($param === 'list-images.php' || $param === 'list-images') {
    require_admin();
    require __DIR__ . '/admin/list-images.php';
```

**Commit:** `c05bf92` - Fix: Blog-Bild-Upload auf Production - Router & Pattern

---

### 2. Pattern-Validierung entfernt

**Problem:** HTML5 `pattern="[a-z0-9-]+"` verursachte Fehler mit neuem `/v` Flag.

**Datei:** `src/admin/blog-post-edit.php`

**Änderung:**
```html
<!-- Vorher: -->
<input pattern="[a-z0-9-]+" required>

<!-- Nachher: -->
<input required>
```

**Begründung:** Server-seitige Validierung ist vorhanden und ausreichend.

**Commit:** `38949b7` - Fix: Pattern-Attribut entfernt - /v Flag zu strikt

---

### 3. Vorschau-Button: Route hinzugefügt

**Problem:** `/admin/preview-markdown.php` Route fehlte im Router.

**Datei:** `src/router.php`

**Änderung:**
```php
} elseif ($param === 'preview-markdown.php' || $param === 'preview-markdown') {
    require_admin();
    require __DIR__ . '/admin/preview-markdown.php';
```

**Commit:** `c761d15` - Fix: Blog-Editor Vorschau & Markdown-Zeilenumbrüche

---

### 4. Markdown: Zeilenumbrüche aktiviert

**Problem:** Parsedown ignorierte einzelne Zeilenumbrüche.

**Datei:** `src/core/helpers.php`

**Änderung:**
```php
function markdown_to_html($markdown, $safeMode = true) {
    static $parsedown = null;

    if ($parsedown === null) {
        require_once __DIR__ . '/../lib/Parsedown.php';
        $parsedown = new Parsedown();
        // Zeilenumbrüche aktivieren (Enter = <br>)
        $parsedown->setBreaksEnabled(true);
    }
    // ...
}
```

**Ergebnis:**
- Ein Enter → `<br>` Tag
- Doppelter Enter → neuer Absatz (`<p>`)

**Commit:** `c761d15` - Fix: Blog-Editor Vorschau & Markdown-Zeilenumbrüche

---

### 5. Listen: Bullets/Nummern CSS-Fix

**Problem:** `<ul>` und `<ol>` hatten keine sichtbaren Bullets/Nummern.

**Datei:** `src/assets/css/components.css`

**Änderung:**
```css
.blog-post-content ul {
    list-style-type: disc;
}

.blog-post-content ol {
    list-style-type: decimal;
}

.blog-post-content li {
    margin-bottom: 0.5rem;
    display: list-item;
}
```

**Commit:** `086c1d5` - Fix: Blog-Listen Bullets & Bildergalerie Anzeige

---

### 6. Bildergalerie: CSS-Fix

**Problem:** Bilder wurden nicht angezeigt, nur Dateinamen bei Mouse-over.

**Datei:** `src/admin/blog-post-edit.php`

**Änderung:**
```css
.gallery-item {
    position: relative;
    aspect-ratio: 1;
    cursor: pointer;
    border-radius: 4px;
    overflow: hidden;
    border: 2px solid transparent;
    transition: border-color 0.2s, transform 0.2s;
    background: var(--bg-tertiary);
}

.gallery-item img {
    position: absolute;  /* ← NEU */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;  /* ← NEU */
}
```

**Commit:** `086c1d5` - Fix: Blog-Listen Bullets & Bildergalerie Anzeige

---

### 7. UPLOADS_PATH korrigiert (Production)

**Problem:** Uploads landeten in `/src/uploads/` statt `/uploads/`.

**Datei:** `src/core/config.php` (nur auf Production-Server)

**Änderung:**
```php
// Vorher:
define('UPLOADS_PATH', BASE_PATH . '/uploads');  // → /src/uploads

// Nachher:
define('UPLOADS_PATH', dirname(BASE_PATH) . '/uploads');  // → /uploads
```

**Zusätzlich:** `.htaccess` auf Production angepasst:
```apache
# Statische Assets aus src/ ausliefern
RewriteRule ^assets/(.*)$ src/assets/$1 [L]
RewriteRule ^uploads/(.*)$ uploads/$1 [L]  # ← NEU
RewriteRule ^favicon\.(.*)$ src/favicon.$1 [L]
```

**Ergebnis:** Uploads funktionieren jetzt, Bilder werden korrekt gespeichert und angezeigt.

---

### 8. Favicons erstellt

**Problem:** Favicon fehlte in Chrome/Edge.

**Generiert mit ImageMagick:**
```bash
convert src/assets/images/logo-square.svg -resize 180x180 src/assets/images/favicon.png
convert src/assets/images/logo-square.svg -resize 32x32 src/assets/images/favicon-32.png
convert src/assets/images/logo-square.svg -resize 16x16 /tmp/favicon-16.png
convert src/assets/images/logo-square.svg -resize 32x32 /tmp/favicon-32.png
convert src/assets/images/logo-square.svg -resize 48x48 /tmp/favicon-48.png
convert /tmp/favicon-16.png /tmp/favicon-32.png /tmp/favicon-48.png src/assets/images/favicon.ico
```

**Datei:** `src/templates/header.php`

**Änderung:**
```html
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="<?= asset('images/favicon.ico') ?>">
<link rel="icon" type="image/svg+xml" href="<?= asset('images/logo-square.svg') ?>">
<link rel="alternate icon" type="image/png" href="<?= asset('images/favicon.png') ?>">
```

**Commits:**
- `e5fa225` - Add: Favicon PNG-Dateien generiert
- `dc4b676` - Add: favicon.ico für bessere Browser-Kompatibilität

---

### 9. HTML-Syntaxfehler behoben

**Problem:** Schließende Klammer am Ende des favicon.png Links.

**Datei:** `src/templates/header.php`

**Änderung:**
```html
<!-- Vorher: -->
<link rel="alternate icon" type="image/png" href="<?= asset('images/favicon.png') ?>")

<!-- Nachher: -->
<link rel="alternate icon" type="image/png" href="<?= asset('images/favicon.png') ?>">
```

**Commit:** `ba2858c` - Fix: Syntaxfehler im Favicon-Link entfernt

**Danke:** Samuel Rüegger für den Hinweis!

---

## Deployment

### Git-Workflow

**Lokale Entwicklung:**
```bash
# Auf master entwickeln
git checkout master
git add src/
git commit -m "Fix: Beschreibung"

# Auf production übertragen
git checkout production
git cherry-pick COMMIT_HASH
git push origin production

# master pushen
git checkout master
git push origin master
```

**Production-Server:**
```bash
ssh dcp285520007@www116.c.artfiles.de
cd /home/www/doc/28552/dcp285520007/pc-wittfoot.de/www

# Production-Config sichern
git stash push -m "Production-Config"

# Code holen
git pull --no-rebase --no-edit origin production

# Production-Config wiederherstellen
git stash pop
```

### Manuelle Änderungen auf Production

**1. config.php - UPLOADS_PATH korrigiert:**
```php
define('UPLOADS_PATH', dirname(BASE_PATH) . '/uploads');
```

**2. .htaccess - uploads-Route hinzugefügt:**
```apache
RewriteRule ^uploads/(.*)$ uploads/$1 [L]
```

**3. Verzeichnisrechte:**
```bash
chmod 777 uploads/blog/
```

---

## Commits

| Commit | Beschreibung |
|--------|-------------|
| `c05bf92` | Fix: Blog-Bild-Upload auf Production - Router & Pattern |
| `2d506d6` | Fix: Pattern-Fehler - Bindestrich ans Ende verschoben |
| `38949b7` | Fix: Pattern-Attribut entfernt - /v Flag zu strikt |
| `c761d15` | Fix: Blog-Editor Vorschau & Markdown-Zeilenumbrüche |
| `086c1d5` | Fix: Blog-Listen Bullets & Bildergalerie Anzeige |
| `e5fa225` | Add: Favicon PNG-Dateien generiert |
| `dc4b676` | Add: favicon.ico für bessere Browser-Kompatibilität |
| `ba2858c` | Fix: Syntaxfehler im Favicon-Link entfernt |

---

## Ergebnis

### ✅ Blog-Editor vollständig funktionsfähig

**Upload:**
- Bild-Upload funktioniert
- Bilder werden in `/uploads/blog/` gespeichert
- Galerie zeigt Thumbnails korrekt an
- URL wird in Zwischenablage kopiert

**Markdown-Editor:**
- Live-Vorschau funktioniert
- Zeilenumbrüche: Enter = `<br>`, doppelt = Absatz
- Listen mit Bullets (•) und Nummern (1, 2, 3)
- Korrekte Syntax: Leerzeile vor Listen erforderlich

**Favicon:**
- Funktioniert in allen Browsern (Chrome, Firefox, Edge, Safari)
- Multi-Format: .ico, .svg, .png

---

## Lessons Learned

### 1. Router-Routen vollständig definieren

**Problem:** Neue Admin-Endpoints benötigen explizite Router-Einträge.

**Lösung:** Bei neuen .php Dateien im `/admin/` Verzeichnis immer Router-Route hinzufügen:
```php
} elseif ($param === 'endpoint.php' || $param === 'endpoint') {
    require_admin();
    require __DIR__ . '/admin/endpoint.php';
```

### 2. UPLOADS_PATH vs. Assets

**Wichtig:** `uploads/` liegt außerhalb von `src/`, daher:
```php
define('UPLOADS_PATH', dirname(BASE_PATH) . '/uploads');
```

Nicht:
```php
define('UPLOADS_PATH', BASE_PATH . '/uploads');  // ❌ Falsch!
```

### 3. .htaccess für statische Dateien

Alle statischen Verzeichnisse außerhalb von `src/` brauchen eigene Regeln:
```apache
RewriteRule ^assets/(.*)$ src/assets/$1 [L]
RewriteRule ^uploads/(.*)$ uploads/$1 [L]
```

### 4. HTML5 Pattern mit /v Flag

Moderne Browser verwenden das `/v` Flag für Regex-Validierung. Bindestriche in Zeichenklassen müssen escaped oder ans Ende:
- ❌ `[a-z0-9-]+`
- ❌ `[a-z0-9\-]+`
- ✅ `[a-z0-9-]+` (am Ende)
- ✅ `[-a-z0-9]+` (am Anfang)

Oder einfach Pattern entfernen wenn Server-Validierung vorhanden ist.

### 5. Parsedown Breaks

Für natürliche Zeilenumbrüche:
```php
$parsedown->setBreaksEnabled(true);
```

### 6. CSS List-Style

Browser-Reset entfernt oft `list-style`. Explizit setzen:
```css
ul { list-style-type: disc; }
ol { list-style-type: decimal; }
li { display: list-item; }
```

---

## Nächste Schritte

**Empfehlungen für zukünftige Sessions:**

1. **Blog-Features testen:**
   - Mehrere Blog-Posts mit Bildern erstellen
   - SEO-Optimierung (Meta-Descriptions, Alt-Texte)
   - RSS-Feed testen

2. **Performance:**
   - Bild-Optimierung (WebP-Konvertierung)
   - Lazy-Loading für Blog-Bilder
   - CDN für statische Assets

3. **Backup-Strategie:**
   - Automatische Backups von `uploads/`
   - Regelmäßige DB-Dumps

4. **Monitoring:**
   - Fehler-Logs überwachen
   - Upload-Quota prüfen
   - Disk-Space monitoring

---

## Support & Danksagungen

**Danke an:**
- Samuel Rüegger für den Hinweis auf den HTML-Syntaxfehler!

**Bei Fragen:**
- Session-Log: `docs/session-logs/2026-01-20.md`
- Git-Workflow: `docs/10-git-workflow.md`
- Deployment: `docs/08-deployment-ops.md`
